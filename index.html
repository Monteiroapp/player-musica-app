<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player de M√∫sica PWA</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ff9800" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #2c3e50);
      color: #fff;
      text-align: center;
      padding: 20px;
      margin: 0;
    }

    h1 {
      margin-bottom: 20px;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .player {
      background: #2a2a3d;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.5);
      max-width: 420px;
      margin: auto;
      box-sizing: border-box;
      width: 100%;
    }

    .cover {
      width: 100%;
      max-width: 300px;
      border-radius: 15px;
      margin: 15px auto;
      object-fit: cover;
      box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.5);
    }

    audio {
      display: none;
    }

    .controls {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }

    button {
      background: linear-gradient(135deg, #ff9800, #ff5722);
      border: none;
      padding: 20px;
      border-radius: 50%;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.5em;
      transition: 0.3s;
      width: 60px;
      height: 60px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.3);
    }

    button:hover {
      background: linear-gradient(135deg, #e68900, #e64a19);
    }

    button.active {
      background: #4caf50;
      color: #fff;
    }

    ul {
      list-style: none;
      padding: 0;
      margin-top: 20px;
      max-height: 160px;
      overflow-y: auto;
    }

    li {
      padding: 12px 10px;
      margin: 6px 0;
      background: #3b3b5c;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 1em;
    }

    li:hover {
      background: #505072;
    }

    li.active {
      background: #ff9800;
      color: #000;
      font-weight: bold;
    }

    #infoMusica {
      margin-top: 10px;
      font-size: 1em;
      color: #ddd;
      min-height: 1.2em;
    }

    .progress-container {
      background: #444;
      border-radius: 10px;
      height: 12px;
      margin: 15px 0;
      cursor: pointer;
      position: relative;
    }

    .progress {
      background: #ff9800;
      height: 100%;
      width: 0%;
      border-radius: 10px;
      transition: width 0.2s;
    }

    .time {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: -4px;
    }

    input[type="file"] {
      display: none;
    }

    .custom-file-upload {
      background: linear-gradient(135deg, #ff9800, #ff5722);
      color: #fff;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: bold;
      display: inline-block;
      margin-top: 15px;
      transition: 0.3s;
    }

    .custom-file-upload:hover {
      background: linear-gradient(135deg, #e68900, #e64a19);
    }
  </style>
</head>
<body>
  <h1>
    <img src="icons/icon-192.png" alt="√çcone Player" style="width: 80px; height: 80px;" />
    Player de M√∫sica PWA
  </h1>

  <div class="player">
    <img
      id="capaMusica"
      class="cover"
      src="https://via.placeholder.com/250x250?text=Capa+Indispon√≠vel"
      alt="Capa do √Ålbum"
    />
    <h3 id="musicaTitulo">Nenhuma m√∫sica selecionada</h3>
    <p id="infoMusica"></p>

    <div class="progress-container" id="progressContainer">
      <div class="progress" id="progress"></div>
    </div>

    <div class="time">
      <span id="tempoAtual">0:00</span>
      <span id="tempoTotal">0:00</span>
    </div>

    <audio id="audio"></audio>

    <div class="controls">
      <button onclick="prevMusica()">‚èÆ</button>
      <button onclick="playPause()">‚èØ</button>
      <button onclick="nextMusica()">‚è≠</button>
      <button id="shuffleBtn" onclick="toggleShuffle()">üîÄ</button>
      <button id="repeatBtn" onclick="toggleRepeat()">üîÅ</button>
    </div>

    <label for="uploadMusicas" class="custom-file-upload">üéµ Selecionar M√∫sicas (MP3)</label>
    <input type="file" id="uploadMusicas" multiple accept="audio/*" />
    <ul id="listaMusicas"></ul>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
  <script>
    const audio = document.getElementById("audio");
    audio.volume = 1;

    const musicaTitulo = document.getElementById("musicaTitulo");
    const capaMusica = document.getElementById("capaMusica");
    const listaMusicas = document.getElementById("listaMusicas");
    const uploadMusicas = document.getElementById("uploadMusicas");
    const infoMusica = document.getElementById("infoMusica");
    const progressContainer = document.getElementById("progressContainer");
    const progress = document.getElementById("progress");
    const tempoAtualEl = document.getElementById("tempoAtual");
    const tempoTotalEl = document.getElementById("tempoTotal");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const repeatBtn = document.getElementById("repeatBtn");

    let musicas = [];
    let musicaAtual = 0;
    let shuffle = false;
    let repeat = false;

    function carregarMusica(index) {
      musicaAtual = index;
      const musica = musicas[index];
      audio.src = URL.createObjectURL(musica.file);
      musicaTitulo.textContent = musica.titulo;
      infoMusica.textContent = `${musica.artista || "Artista desconhecido"} ‚Ä¢ ${musica.album || "√Ålbum desconhecido"}`;
      capaMusica.src = musica.capa || "https://via.placeholder.com/250x250?text=Capa+Indispon√≠vel";
      audio.play();

      const items = listaMusicas.getElementsByTagName("li");
      for (let i = 0; i < items.length; i++) {
        items[i].classList.remove("active");
      }
      items[index].classList.add("active");
    }

    function playPause() {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
    }

    function nextMusica() {
      if (musicas.length === 0) return;
      if (repeat) {
        carregarMusica(musicaAtual);
      } else if (shuffle) {
        let nova;
        do {
          nova = Math.floor(Math.random() * musicas.length);
        } while (nova === musicaAtual && musicas.length > 1);
        carregarMusica(nova);
      } else {
        musicaAtual = (musicaAtual + 1) % musicas.length;
        carregarMusica(musicaAtual);
      }
    }

    function prevMusica() {
      if (musicas.length === 0) return;
      musicaAtual = (musicaAtual - 1 + musicas.length) % musicas.length;
      carregarMusica(musicaAtual);
    }

    function toggleShuffle() {
      shuffle = !shuffle;
      shuffleBtn.classList.toggle("active", shuffle);
    }

    function toggleRepeat() {
      repeat = !repeat;
      repeatBtn.classList.toggle("active", repeat);
    }

    audio.addEventListener("timeupdate", () => {
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        progress.style.width = `${percent}%`;
        tempoAtualEl.textContent = formatarTempo(audio.currentTime);
        tempoTotalEl.textContent = formatarTempo(audio.duration);
      }
    });

    progressContainer.addEventListener("click", (e) => {
      const width = progressContainer.clientWidth;
      const clickX = e.offsetX;
      const duration = audio.duration;
      audio.currentTime = (clickX / width) * duration;
    });

    function formatarTempo(segundos) {
      const minutos = Math.floor(segundos / 60);
      const seg = Math.floor(segundos % 60).toString().padStart(2, "0");
      return `${minutos}:${seg}`;
    }

    function extrairCapa(tags) {
      if (tags.picture) {
        const { data, format } = tags.picture;
        let base64 = "";
        const bytes = new Uint8Array(data);
        for (let i = 0; i < bytes.length; i++) {
          base64 += String.fromCharCode(bytes[i]);
        }
        return `data:${format};base64,${btoa(base64)}`;
      }
      return null;
    }

    uploadMusicas.addEventListener("change", (e) => {
      const arquivos = Array.from(e.target.files);
      musicas = [];

      arquivos.forEach((arquivo, index) => {
        const musica = {
          titulo: arquivo.name,
          artista: null,
          album: null,
          file: arquivo,
          capa: "https://via.placeholder.com/250x250?text=Capa+Indispon√≠vel"
        };

        jsmediatags.read(arquivo, {
          onSuccess: (tag) => {
            if (tag.tags.title) musica.titulo = tag.tags.title;
            if (tag.tags.artist) musica.artista = tag.tags.artist;
            if (tag.tags.album) musica.album = tag.tags.album;
            const capaExtraida = extrairCapa(tag.tags);
            if (capaExtraida) musica.capa = capaExtraida;
            atualizarLista();
          },
          onError: () => atualizarLista()
        });

        musicas.push(musica);
      });

      function atualizarLista() {
        listaMusicas.innerHTML = "";
        musicas.forEach((m, i) => {
          const li = document.createElement("li");
          li.textContent = "üéµ " + m.titulo;
          li.onclick = () => carregarMusica(i);
          listaMusicas.appendChild(li);
        });
        if (musicas.length > 0 && audio.src === "") {
          carregarMusica(0);
        }
      }
    });

    audio.addEventListener("ended", nextMusica);
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js")
        .then((reg) => console.log("SW registrado:", reg.scope))
        .catch((err) => console.log("Falha SW:", err));
    }
  </script>
</body>
</html>
